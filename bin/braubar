#!/usr/bin/env python3

import os
import argparse
import sys
import subprocess

os.system("export PYTHONPATH=/home/pi/braubar-pi-master/braubar/service")

if os.getcwd().endswith("bin"):
    sys.path.append("../braubar")
    sys.path.append("../braubar/service")
else:
    raise Exception("please start braubar from bin directory!!")
from service.brewconfig import BrewConfig

SENSOR_PORT = BrewConfig().get("braubar")["sensor_port"]
POWERSTRIP_URL = BrewConfig().get('powerstrip')['url']

parser = argparse.ArgumentParser(description="BrauBar daemon at your service.")
parser.add_argument('--host', help="IP-Address to listen on. Default is 0.0.0.0", default="0.0.0.0")
parser.add_argument('--powerstrip', help="URL for Powerstrip. Format:e.g. 'http://localhost:8080'", default=POWERSTRIP_URL)
args = parser.parse_args()
HOST_IP = args.host
FLASK_FILE = "../braubar/flask_app.py"
BREWDAEMON_FILE = "../braubar/brewdaemon"
powerstrip_url = args.powerstrip


def start_flask(host=HOST_IP, brew_id=None):
    flask_args = ["python3", FLASK_FILE, "--host", host]
    if brew_id:
        flask_args.append("--id")
        flask_args.append(str(brew_id))
    subprocess.Popen(flask_args)

try:
    start_flask(host=HOST_IP)
except KeyboardInterrupt:
    print("BrewDaemon is shutting down ...")

print("bye")
